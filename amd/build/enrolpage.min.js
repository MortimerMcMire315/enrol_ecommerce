define(["jquery","core/modal_factory"],function(a,b){var c={MultipleRegistration:{enabled:!1,nextEmailID:1,getEmails:function(){var b=[];return a(".mr-email-line input").each(function(){var c=a(this).val();""!==a.trim(c)&&b.push(c)}),b},addPlusClickHandler:function(b,c){var d=this;b.click(function(){var b=d.makeEmailEntryLine(c);a(".plus-container").remove();var e=a("#multiple-registration-container").append(b);d.addPlusClickHandler(a(".plus-container"),c),d.addMinusClickHandler(e.find(".minus-container"),c)})},addMinusClickHandler:function(b,c){var d=this;b.click(function(){a(this).parent().remove(),a(".mr-email-line:last .plus-container").length||(a(".mr-email-line:last").append(d.makePlusSign(c)),d.addPlusClickHandler(a(".plus-container"),c)),d.refreshEmailNums()})},makePlusSign:function(a){var b='<div class="plus-container"><img src="'+a+'/enrol/ecommerce/pix/plus.svg" class="plus"></div>';return b},makePlusAndMinusSigns:function(a,b){var c=this.makePlusSign(b),d='<div class="minus-container"><img src="'+b+'/enrol/ecommerce/pix/minus.svg" class="minus"></div>';return a>1?c+d:c},refreshEmailNums:function(){var b=-1;return a(".email-num").each(function(c){a(this).text(c+1),b=c}),b+2},makeEmailEntryLine:function(a){var b=this,c=b.refreshEmailNums(),d=b.nextEmailID;b.nextEmailID=b.nextEmailID+1;var e='"multiple-registration-email-'+d+'"',f='<div class="mr-email-line">',g='<div class="mr-email-label-container"><label for='+e+'>Email <span class="email-num">'+c+"</span>:&nbsp;&nbsp;&nbsp;</label></div>",h="<input id="+e+' type="text" class="multiple-registration-email" />',i="</div>";return f+g+h+this.makePlusAndMinusSigns(d,a)+i},handleEmailSubmitAJAXResponse:function(c,d){var e=JSON.parse(d);if(e.success){var f=a("#success-modal-trigger");f.off(),b.create({type:b.types.SAVE_CANCEL,title:"Continue Checkout",body:"Test Test Test",savechanges:"Confirm",cancel:"Cancel"},f).done(a("#enrol-ecommerce-checkout").submit()),a("#success-modal-trigger").click()}else{var f=a("#error-modal-trigger");f.off(),b.create({type:b.types.DEFAULT,body:e.failmessage,closebuttontitle:"Dismiss"},f),a("#error-modal-trigger").click()}},verifyAndSubmit:function(b,c,d){var e=this,f=e.getEmails();if(f.length){var g=c+"/enrol/ecommerce/ajax/multiple_enrol.php";a.ajax({url:g,method:"POST",data:{instanceid:b,emails:JSON.stringify(f),ipn_id:a("#enrol-ecommerce-checkout-custom").val()},context:document.body,success:function(a){e.handleEmailSubmitAJAXResponse(d,a)}})}else alert("No valid emails have been entered.")},multipleRegistration:function(b,c,d){var e=this;d.hasClass("enable-mr")?(e.enabled=!0,e.nextEmailID=1,d.text("Cancel multiple registration"),d.removeClass("enable-mr").addClass("disable-mr"),a("#enrol-ecommerce-submit").val("Verify emails and send payment"),a("#multiple-registration-container").html(this.makeEmailEntryLine(c)),e.addPlusClickHandler(a(".plus-container"),c)):d.hasClass("disable-mr")&&(e.enabled=!1,d.text("Multiple Registration"),d.removeClass("disable-mr").addClass("enable-mr"),a("#enrol-ecommerce-submit").val("Send payment via PayPal"),a("#enrol-ecommerce-submit").removeClass("multiple-enrol"),a(".mr-email-line").remove())}},Discount:{checkDiscountCode:function(b,c){var d=a("#discountcode").val(),e=c+"/enrol/ecommerce/check_discount.php";a.ajax({url:e,data:{discountcode:d,instanceid:b},context:document.body,success:function(b){var c=JSON.parse(b);if(c.success){var d=c.discounted_cost;a("span#localisedcost").text(d),a("input[name=amount]").val(d)}else alert("Invalid discount code.")}})}},init:function(b,c){var d=this;a("#apply-discount").click(function(){d.Discount.handleDiscountCode(b,c)}),a("#multiple-registration-btn").click(function(){d.MultipleRegistration.multipleRegistration(b,c,a(this))}),a("#enrol-ecommerce-submit").click(function(a){d.MultipleRegistration.enabled&&(a.preventDefault(),d.MultipleRegistration.verifyAndSubmit(b,c,d.Discount))})}};return c});