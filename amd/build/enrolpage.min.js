define(["jquery","core/modal_factory","core/modal_events","core/str","core/config","enrol_ecommerce/spin"],function(a,b,c,d,e,f){var g={mdlstr:void 0,gateway:null,originalCost:void 0,subtotal:void 0,instanceid:void 0,prepayToken:void 0,MultipleRegistration:{enabled:!1,nextEmailID:1,getEmails:function(){var b=[];return a(".mr-email-line input").each(function(){var c=a(this).val();""!==a.trim(c)&&b.push(c)}),b},addPlusClickHandler:function(b){var c=this;b.click(function(){var b=c.makeEmailEntryLine();a(".plus-container").remove();var d=a("#multiple-registration-container").append(b);c.addPlusClickHandler(a(".plus-container")),c.addMinusClickHandler(d.find(".minus-container"))})},addMinusClickHandler:function(b){var c=this;b.click(function(){a(this).parent().remove(),a(".mr-email-line:last .plus-container").length||(a(".mr-email-line:last").append(c.makePlusSign()),c.addPlusClickHandler(a(".plus-container"))),c.refreshEmailNums()})},makePlusSign:function(){var a='<div class="plus-container"><img src="'+e.wwwroot+'/enrol/ecommerce/pix/plus.svg" class="plus"></div>';return a},makePlusAndMinusSigns:function(a){var b=this.makePlusSign(),c='<div class="minus-container"><img src="'+e.wwwroot+'/enrol/ecommerce/pix/minus.svg" class="minus"></div>';return a>1?b+c:b},refreshEmailNums:function(){var b=-1;return a(".email-num").each(function(c){a(this).text(c+1),b=c}),b+2},makeEmailEntryLine:function(){var a=this,b=a.refreshEmailNums(),c=a.nextEmailID;a.nextEmailID=a.nextEmailID+1;var d='"multiple-registration-email-'+c+'"',e='<div class="mr-email-line">',f='<div class="mr-email-label-container"><label for='+d+'>Email <span class="email-num">'+b+"</span>:&nbsp;&nbsp;&nbsp;</label></div>",g="<input id="+d+' type="text" class="multiple-registration-email" />',h="</div>";return e+f+g+this.makePlusAndMinusSigns(c)+h},checkoutConfirmModal:function(d,e){var f=a("#success-modal-trigger");f.off(),b.create({type:b.types.SAVE_CANCEL,title:"Continue Checkout",body:e},f).done(function(a){a.setSaveButtonText("Confirm Payment"),a.getRoot().on(c.save,function(a){a.preventDefault(),d.checkoutFinal()})}),a("#success-modal-trigger").click()},handleEmailSubmitAJAXResponse:function(c,d){var e=this,f=JSON.parse(c);if(f.success)d.subtotal=f.subtotal,d.updateCostView(),e.checkoutConfirmModal(d,f.successmessage);else{var g=a("#error-modal-trigger");g.off(),b.create({type:b.types.DEFAULT,body:f.failmessage,closebuttontitle:"Dismiss"},g),a("#error-modal-trigger").click()}},verifyAndSubmit:function(b){var c=this;if("paypal"!==b.gateway&&"stripe"!==b.gateway)throw alert("Invalid payment provider."),new Error("Invalid payment provider.");var d=c.getEmails();if(d.length){var f=e.wwwroot+"/enrol/ecommerce/ajax/multiple_enrol.php";a.ajax({url:f,method:"POST",data:{instanceid:b.instanceid,prepaytoken:b.prepayToken,emails:JSON.stringify(d),ipn_id:a("#"+b.gateway+"-custom").val()},context:document.body,success:function(a){c.handleEmailSubmitAJAXResponse(a,b)}})}else alert("No valid emails have been entered.")},buildForm:function(b){var c=this;b.hasClass("enable-mr")?(c.enabled=!0,c.nextEmailID=1,b.text("Cancel multiple registration"),b.removeClass("enable-mr").addClass("disable-mr"),a("#multiple-registration-container").html(this.makeEmailEntryLine()),c.addPlusClickHandler(a(".plus-container"))):b.hasClass("disable-mr")&&(c.enabled=!1,b.text("Multiple Registration"),b.removeClass("disable-mr").addClass("enable-mr"),a(".mr-email-line").remove())}},Discount:{checkDiscountCode:function(b){var c=a("#discountcode").val(),d=e.wwwroot+"/enrol/ecommerce/ajax/check_discount.php";a.ajax({url:d,data:{discountcode:c,instanceid:b.instanceid,prepaytoken:b.prepayToken},context:document.body,success:function(a){var c=JSON.parse(a);c.success?b.subtotal=c.subtotal:alert(c.failmessage)}})}},checkoutFinal:function(){if("paypal"===this.gateway)a("#paypal-form").submit();else{if("stripe"!==this.gateway)throw new Error(this.mdlstr.invalidgateway);this.stripeCheckout()}},updateCostView:function(){a("span#localisedcost").text(this.subtotal),a("input[name=amount]").val(this.subtotal)},stripeCheckout:function(b){var c=this;a.getScript("https://checkout.stripe.com/checkout.js",function(){var d=StripeCheckout.configure({key:c.stripePublishableKey,image:"https://stripe.com/img/documentation/checkout/marketplace.png",locale:"auto",shippingAddress:!0,token:function(b){a("#enrol-ecommerce-stripe-checkout").append('<input type="hidden" name="stripeToken" value="'+b.id+'" />').append('<input type="hidden" name="stripeTokenType" value="'+b.type+'" />').append('<input type="hidden" name="stripeEmail" value="'+b.email+'" />').submit()}});d.open({name:b,description:"Test description",zipCode:!0,amount:c.subtotal})}).fail(function(){throw new Error("Could not load Stripe checkout library.")})},initClickHandlers:function(){var b=this;a("#apply-discount").click(function(){b.Discount.checkDiscountCode(b)}),a("#multiple-registration-btn").click(function(){b.MultipleRegistration.buildForm(a(this))}),a(".ecommerce-checkout").click(function(c){c.preventDefault(),"paypal-button"===c.target.id?b.gateway="paypal":"stripe-button"===c.target.id&&(b.gateway="stripe"),b.MultipleRegistration.enabled?b.MultipleRegistration.verifyAndSubmit(b):"paypal"===b.gateway?a("#paypal-form").submit():"stripe"===b.gateway?b.stripeCheckout():alert(b.mdlstr.invalidgateway)})},init:function(a,b,c,e,f,g){var h=this,i=d.get_strings([{key:"discounttypeerror",component:"enrol_ecommerce"},{key:"discountamounterror",component:"enrol_ecommerce"},{key:"invalidgateway",component:"enrol_ecommerce"}]);i.done(function(d){h.mdlstr=d,h.originalCost=c,h.subtotal=c,h.instanceid=a,h.stripePublishableKey=b,h.courseFullName=f,h.shippingRequired=g,alert(e),h.prepayToken=e,h.initClickHandlers(),h.updateCostView()})}};return g});