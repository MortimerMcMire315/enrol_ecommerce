define(["jquery","core/modal_factory","core/modal_events","core/str","core/config","enrol_payment/spin"],function(y,a,n,e,o,t){return{mdlstr:void 0,gateway:null,originalCost:void 0,subtotal:void 0,taxAmount:void 0,instanceid:void 0,prepayToken:void 0,billingAddressRequired:void 0,validateZipCode:void 0,shippingAddressRequired:void 0,userEmail:void 0,currency:void 0,MultipleRegistration:{enabled:!1,nextEmailID:1,getEmails:function(){var t=[];return y(".mr-email-line input").each(function(){var e=y(this).val();""!==y.trim(e)&&t.push(e)}),t},addPlusClickHandler:function(e,i){var n=this;e.click(function(){var e=n.makeEmailEntryLine(i);y(".plus-container").remove();var t=y("#multiple-registration-container").append(e);n.addPlusClickHandler(y(".plus-container"),i),n.addMinusClickHandler(t.find(".minus-container"),i)})},addMinusClickHandler:function(e,t){var i=this;e.click(function(){y(this).parent().remove(),y(".mr-email-line:last .plus-container").length||(y(".mr-email-line:last").append(i.makePlusSign(t)),i.addPlusClickHandler(y(".plus-container"),t)),i.refreshEmailNums()})},makePlusSign:function(e){return'<div class="plus-container" title="'+e[4]+'"><img src="'+o.wwwroot+'/enrol/payment/pix/plus.svg" class="plus"></div>'},makePlusAndMinusSigns:function(e,t){var i=this.makePlusSign(t),n='<div class="minus-container" title="'+t[5]+'"><img src="'+o.wwwroot+'/enrol/payment/pix/minus.svg" class="minus"></div>';return 1<e?i+n:i},refreshEmailNums:function(){var t=-1;return y(".email-num").each(function(e){y(this).text(e+1),t=e}),t+2},makeEmailEntryLine:function(e){var t=this,i=t.refreshEmailNums(),n=t.nextEmailID;t.nextEmailID=t.nextEmailID+1;var a='"multiple-registration-email-'+n+'"';return'<div class="mr-email-line">'+('<div class="mr-email-label-container"><label for='+a+'>Email <span class="email-num">'+i+"</span>:&nbsp;&nbsp;&nbsp;</label></div>")+("<input id="+a+' type="text" class="multiple-registration-email" />')+this.makePlusAndMinusSigns(n,e)+"</div>"},checkoutConfirmModal:function(t,e){var i=y("#success-modal-trigger");i.off(),a.create({type:a.types.SAVE_CANCEL,title:"Continue Checkout",body:e},i).done(function(e){e.setSaveButtonText("Confirm Payment"),e.getRoot().on(n.save,function(){t.checkoutFinal()})}),y("#success-modal-trigger").click()},handleEmailSubmitAJAXResponse:function(e,t){var i=JSON.parse(e);if(i.success)t.subtotal=i.subtotal,t.updateCostView(),this.checkoutConfirmModal(t,i.successmessage);else{var n=y("#error-modal-trigger");n.off(),a.create({type:a.types.DEFAULT,body:i.failmessage,closebuttontitle:"Dismiss"},n),y("#error-modal-trigger").click()}},verifyAndSubmit:function(t){var i=this;if("paypal"!==t.gateway&&"stripe"!==t.gateway)throw alert("Invalid payment provider."),new Error("Invalid payment provider.");var e=i.getEmails();if(e.length){var n=o.wwwroot+"/enrol/payment/ajax/multiple_enrol.php";y.ajax({url:n,method:"POST",data:{instanceid:t.instanceid,prepaytoken:t.prepayToken,emails:JSON.stringify(e),ipn_id:y("#"+t.gateway+"-custom").val()},context:document.body,success:function(e){i.handleEmailSubmitAJAXResponse(e,t)}})}else alert("No valid emails have been entered.")},buildForm:function(e,t){var i=this;i.enabled?(i.enabled=!1,e.text("Multiple Registration"),e.removeClass("disable-mr").addClass("enable-mr"),y(".mr-email-line").remove()):(i.enabled=!0,i.nextEmailID=1,e.text("Cancel multiple registration"),e.removeClass("enable-mr").addClass("disable-mr"),y("#multiple-registration-container").html(this.makeEmailEntryLine(t)),i.addPlusClickHandler(y(".plus-container"),t))}},Discount:{checkDiscountCode:function(i){var e=y("#discountcode").val(),t=o.wwwroot+"/enrol/payment/ajax/check_discount.php";y.ajax({url:t,data:{discountcode:e,instanceid:i.instanceid,prepaytoken:i.prepayToken},context:document.body,success:function(e){var t=JSON.parse(e);t.success?(i.subtotal=t.subtotal,i.updateCostView()):alert(t.failmessage)}})}},checkoutFinal:function(){if("paypal"===this.gateway)y("#paypal-form input[name=amount]").val(this.subtotal),y("#paypal-form input[name=tax]").val(this.taxAmount*this.subtotal),y("#paypal-form").submit();else{if("stripe"!==this.gateway)throw new Error(this.mdlstr[2]);y("#stripe-form input[name=amount]").val(this.subtotal),this.stripeCheckout()}},getTaxedAmount:function(){var e=Number.parseFloat(this.subtotal),t=Number.parseFloat(this.taxAmount);return Number.parseFloat(e+e*t).toFixed(2)},updateCostView:function(){y("span#localisedcost").text(this.getTaxedAmount()),y("span.subtotal-display").text(this.getTaxedAmount())},stripeCheckout:function(){var e=this;y.getScript("https://checkout.stripe.com/checkout.js",function(){alert(e.shippingAddressRequired?"yo":"no"),StripeCheckout.configure({key:e.stripePublishableKey,image:e.stripeLogo||"https://stripe.com/img/documentation/checkout/marketplace.png",locale:"auto",billingAddressRequired:e.billingAddressRequired,shippingAddress:e.shippingAddressRequired,email:e.userEmail,allowRememberMe:!1,zipCode:e.validateZipCode,token:function(e){y("#stripe-form").append('<input type="hidden" name="stripeToken" value="'+e.id+'" />').append('<input type="hidden" name="stripeTokenType" value="'+e.type+'" />').append('<input type="hidden" name="stripeEmail" value="'+e.email+'" />').submit()}}).open({name:e.courseFullName,description:"Total enrolment fee: $"+e.getTaxedAmount()+" "+e.currency,zipCode:!0,amount:Math.floor(100*Number.parseFloat(e.getTaxedAmount()))})}).fail(function(){throw new Error("Could not load Stripe checkout library.")})},initClickHandlers:function(){var t=this;y("#apply-discount").click(function(){t.Discount.checkDiscountCode(t)}),y("#multiple-registration-btn").click(function(){t.MultipleRegistration.buildForm(y(this),t.mdlstr)}),y(".payment-checkout").click(function(e){e.preventDefault(),"paypal-button"===e.target.id?t.gateway="paypal":"stripe-button"===e.target.id&&(t.gateway="stripe"),t.MultipleRegistration.enabled?t.MultipleRegistration.verifyAndSubmit(t):y.ajax({url:o.wwwroot+"/enrol/payment/ajax/single_enrol.php",method:"POST",data:{prepaytoken:t.prepayToken},success:function(){t.checkoutFinal()},failure:function(){alert(t.mdlstr[3])}})})},init:function(t,i,n,a,o,r,s,l,u,c,p,d){var m=this;e.get_strings([{key:"discounttypeerror",component:"enrol_payment"},{key:"discountamounterror",component:"enrol_payment"},{key:"invalidgateway",component:"enrol_payment"},{key:"errcommunicating",component:"enrol_payment"},{key:"addaregistrant",component:"enrol_payment"},{key:"removearegistrant",component:"enrol_payment"}]).done(function(e){m.mdlstr=e,m.originalCost=Number.parseFloat(n),m.taxAmount=Number.parseFloat(l),m.subtotal=Number.parseFloat(n).toFixed(2),m.instanceid=t,m.stripePublishableKey=i,m.courseFullName=o,m.shippingAddressRequired=r,m.prepayToken=a,m.stripeLogo=s,m.validateZipCode=u,m.billingAddressRequired=c,m.userEmail=p,m.currency=d,m.initClickHandlers(),m.updateCostView(),y("#dimmer").css("display","none")})}}});