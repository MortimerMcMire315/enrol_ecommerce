define(["jquery","core/modal_factory","core/modal_events","core/str","core/config","enrol_ecommerce/spin"],function(a,o,n,e,r,t){return{mdlstr:void 0,gateway:null,originalCost:void 0,subtotal:void 0,instanceid:void 0,prepayToken:void 0,MultipleRegistration:{enabled:!1,nextEmailID:1,getEmails:function(){var t=[];return a(".mr-email-line input").each(function(){var e=a(this).val();""!==a.trim(e)&&t.push(e)}),t},addPlusClickHandler:function(e){var i=this;e.click(function(){var e=i.makeEmailEntryLine();a(".plus-container").remove();var t=a("#multiple-registration-container").append(e);i.addPlusClickHandler(a(".plus-container")),i.addMinusClickHandler(t.find(".minus-container"))})},addMinusClickHandler:function(e){var t=this;e.click(function(){a(this).parent().remove(),a(".mr-email-line:last .plus-container").length||(a(".mr-email-line:last").append(t.makePlusSign()),t.addPlusClickHandler(a(".plus-container"))),t.refreshEmailNums()})},makePlusSign:function(){return'<div class="plus-container"><img src="'+r.wwwroot+'/enrol/ecommerce/pix/plus.svg" class="plus"></div>'},makePlusAndMinusSigns:function(e){var t=this.makePlusSign(),i='<div class="minus-container"><img src="'+r.wwwroot+'/enrol/ecommerce/pix/minus.svg" class="minus"></div>';return 1<e?t+i:t},refreshEmailNums:function(){var t=-1;return a(".email-num").each(function(e){a(this).text(e+1),t=e}),t+2},makeEmailEntryLine:function(){var e=this,t=e.refreshEmailNums(),i=e.nextEmailID;e.nextEmailID=e.nextEmailID+1;var n='"multiple-registration-email-'+i+'"';return'<div class="mr-email-line">'+('<div class="mr-email-label-container"><label for='+n+'>Email <span class="email-num">'+t+"</span>:&nbsp;&nbsp;&nbsp;</label></div>")+("<input id="+n+' type="text" class="multiple-registration-email" />')+this.makePlusAndMinusSigns(i)+"</div>"},checkoutConfirmModal:function(t,e){var i=a("#success-modal-trigger");i.off(),o.create({type:o.types.SAVE_CANCEL,title:"Continue Checkout",body:e},i).done(function(e){e.setSaveButtonText("Confirm Payment"),e.getRoot().on(n.save,function(){t.checkoutFinal()})}),a("#success-modal-trigger").click()},handleEmailSubmitAJAXResponse:function(e,t){var i=JSON.parse(e);if(i.success)t.subtotal=i.subtotal,t.updateCostView(),this.checkoutConfirmModal(t,i.successmessage);else{var n=a("#error-modal-trigger");n.off(),o.create({type:o.types.DEFAULT,body:i.failmessage,closebuttontitle:"Dismiss"},n),a("#error-modal-trigger").click()}},verifyAndSubmit:function(t){var i=this;if("paypal"!==t.gateway&&"stripe"!==t.gateway)throw alert("Invalid payment provider."),new Error("Invalid payment provider.");var e=i.getEmails();if(e.length){var n=r.wwwroot+"/enrol/ecommerce/ajax/multiple_enrol.php";a.ajax({url:n,method:"POST",data:{instanceid:t.instanceid,prepaytoken:t.prepayToken,emails:JSON.stringify(e),ipn_id:a("#"+t.gateway+"-custom").val()},context:document.body,success:function(e){i.handleEmailSubmitAJAXResponse(e,t)}})}else alert("No valid emails have been entered.")},buildForm:function(e){var t=this;t.enabled?(t.enabled=!1,e.text("Multiple Registration"),e.removeClass("disable-mr").addClass("enable-mr"),a(".mr-email-line").remove()):(t.enabled=!0,t.nextEmailID=1,e.text("Cancel multiple registration"),e.removeClass("enable-mr").addClass("disable-mr"),a("#multiple-registration-container").html(this.makeEmailEntryLine()),t.addPlusClickHandler(a(".plus-container")))}},Discount:{checkDiscountCode:function(i){var e=a("#discountcode").val(),t=r.wwwroot+"/enrol/ecommerce/ajax/check_discount.php";a.ajax({url:t,data:{discountcode:e,instanceid:i.instanceid,prepaytoken:i.prepayToken},context:document.body,success:function(e){var t=JSON.parse(e);t.success?(i.subtotal=t.subtotal,i.updateCostView()):alert(t.failmessage)}})}},checkoutFinal:function(){if("paypal"===this.gateway)a("#paypal-form").submit();else{if("stripe"!==this.gateway)throw new Error(this.mdlstr.invalidgateway);this.stripeCheckout()}},updateCostView:function(){a("span#localisedcost").text(this.subtotal),a("span.subtotal-display").text(this.subtotal),a("input[name=amount]").val(this.subtotal)},stripeCheckout:function(e){var t=this;a.getScript("https://checkout.stripe.com/checkout.js",function(){StripeCheckout.configure({key:t.stripePublishableKey,image:t.stripeLogo||"https://stripe.com/img/documentation/checkout/marketplace.png",locale:"auto",shippingAddress:t.shippingRequired,token:function(e){a("#stripe-form").append('<input type="hidden" name="stripeToken" value="'+e.id+'" />').append('<input type="hidden" name="stripeTokenType" value="'+e.type+'" />').append('<input type="hidden" name="stripeEmail" value="'+e.email+'" />').submit()}}).open({name:e,description:"Test description",zipCode:!0,amount:Math.floor(100*Number.parseFloat(t.subtotal))})}).fail(function(){throw new Error("Could not load Stripe checkout library.")})},initClickHandlers:function(){var t=this;a("#apply-discount").click(function(){t.Discount.checkDiscountCode(t)}),a("#multiple-registration-btn").click(function(){t.MultipleRegistration.buildForm(a(this))}),a(".ecommerce-checkout").click(function(e){e.preventDefault(),"paypal-button"===e.target.id?t.gateway="paypal":"stripe-button"===e.target.id&&(t.gateway="stripe"),t.MultipleRegistration.enabled?t.MultipleRegistration.verifyAndSubmit(t):a.ajax({url:r.wwwroot+"/enrol/ecommerce/ajax/single_enrol.php",method:"POST",data:{prepaytoken:t.prepayToken},success:function(){t.checkoutFinal()},failure:function(){alert(t.mdlstr.errcommunicating)}})})},init:function(t,i,n,a,o,r,s){var l=this;e.get_strings([{key:"discounttypeerror",component:"enrol_ecommerce"},{key:"discountamounterror",component:"enrol_ecommerce"},{key:"invalidgateway",component:"enrol_ecommerce"},{key:"errcommunicating",component:"enrol_ecommerce"}]).done(function(e){l.mdlstr=e,l.originalCost=n,l.subtotal=n,l.instanceid=t,l.stripePublishableKey=i,l.courseFullName=o,l.shippingRequired=r,l.prepayToken=a,l.stripeLogo=s,l.initClickHandlers(),l.updateCostView()})}}});