define(["jquery","jqueryui","core/modal_factory","core/modal_events","core/str","core/config","enrol_payment/spin"],function(a,e,o,n,d,r,t){return{mdlstr:void 0,gateway:null,originalCost:void 0,subtotal:void 0,taxAmount:void 0,instanceid:void 0,prepayToken:void 0,billingAddressRequired:void 0,validateZipCode:void 0,shippingRequired:void 0,MultipleRegistration:{enabled:!1,nextEmailID:1,getEmails:function(){var t=[];return a(".mr-email-line input").each(function(){var e=a(this).val();""!==a.trim(e)&&t.push(e)}),t},addPlusClickHandler:function(e,i){var n=this;e.click(function(){var e=n.makeEmailEntryLine(i);a(".plus-container").remove();var t=a("#multiple-registration-container").append(e);n.addPlusClickHandler(a(".plus-container"),i),n.addMinusClickHandler(t.find(".minus-container"),i),a(".plus-container").tooltip(),a(".minus-container").tooltip()})},addMinusClickHandler:function(e,t){var i=this;e.click(function(){a(this).parent().remove(),a(".mr-email-line:last .plus-container").length||(a(".mr-email-line:last").append(i.makePlusSign(t)),i.addPlusClickHandler(a(".plus-container"),t)),i.refreshEmailNums()})},makePlusSign:function(e){return'<div class="plus-container" title="'+e.addaregistrant+'"><img src="'+r.wwwroot+'/enrol/payment/pix/plus.svg" class="plus"></div>'},makePlusAndMinusSigns:function(e,t){var i=this.makePlusSign(t),n='<div class="minus-container" title="'+t.removearegistrant+'"><img src="'+r.wwwroot+'/enrol/payment/pix/minus.svg" class="minus"></div>';return 1<e?i+n:i},refreshEmailNums:function(){var t=-1;return a(".email-num").each(function(e){a(this).text(e+1),t=e}),t+2},makeEmailEntryLine:function(e){var t=this,i=t.refreshEmailNums(),n=t.nextEmailID;t.nextEmailID=t.nextEmailID+1;var a='"multiple-registration-email-'+n+'"';return'<div class="mr-email-line">'+('<div class="mr-email-label-container"><label for='+a+'>Email <span class="email-num">'+i+"</span>:&nbsp;&nbsp;&nbsp;</label></div>")+("<input id="+a+' type="text" class="multiple-registration-email" />')+this.makePlusAndMinusSigns(n,e)+"</div>"},checkoutConfirmModal:function(t,e){var i=a("#success-modal-trigger");i.off(),o.create({type:o.types.SAVE_CANCEL,title:"Continue Checkout",body:e},i).done(function(e){e.setSaveButtonText("Confirm Payment"),e.getRoot().on(n.save,function(){t.checkoutFinal()})}),a("#success-modal-trigger").click()},handleEmailSubmitAJAXResponse:function(e,t){var i=JSON.parse(e);if(i.success)t.subtotal=i.subtotal,t.updateCostView(),this.checkoutConfirmModal(t,i.successmessage);else{var n=a("#error-modal-trigger");n.off(),o.create({type:o.types.DEFAULT,body:i.failmessage,closebuttontitle:"Dismiss"},n),a("#error-modal-trigger").click()}},verifyAndSubmit:function(t){var i=this;if("paypal"!==t.gateway&&"stripe"!==t.gateway)throw alert("Invalid payment provider."),new Error("Invalid payment provider.");var e=i.getEmails();if(e.length){var n=r.wwwroot+"/enrol/payment/ajax/multiple_enrol.php";a.ajax({url:n,method:"POST",data:{instanceid:t.instanceid,prepaytoken:t.prepayToken,emails:JSON.stringify(e),ipn_id:a("#"+t.gateway+"-custom").val()},context:document.body,success:function(e){i.handleEmailSubmitAJAXResponse(e,t)}})}else alert("No valid emails have been entered.")},buildForm:function(e,t){var i=this;i.enabled?(i.enabled=!1,e.text("Multiple Registration"),e.removeClass("disable-mr").addClass("enable-mr"),a(".mr-email-line").remove()):(i.enabled=!0,i.nextEmailID=1,e.text("Cancel multiple registration"),e.removeClass("enable-mr").addClass("disable-mr"),a("#multiple-registration-container").html(this.makeEmailEntryLine(t)),i.addPlusClickHandler(a(".plus-container"),t))}},Discount:{checkDiscountCode:function(i){var e=a("#discountcode").val(),t=r.wwwroot+"/enrol/payment/ajax/check_discount.php";a.ajax({url:t,data:{discountcode:e,instanceid:i.instanceid,prepaytoken:i.prepayToken},context:document.body,success:function(e){var t=JSON.parse(e);t.success?(i.subtotal=t.subtotal,i.updateCostView()):alert(t.failmessage)}})}},checkoutFinal:function(){if("paypal"===this.gateway)a("#paypal-form input[name=amount]").val(this.subtotal),a("#paypal-form input[name=tax]").val(this.taxAmount*this.subtotal),a("#paypal-form").submit();else{if("stripe"!==this.gateway)throw new Error(this.mdlstr.invalidgateway);a("#stripe-form input[name=amount]").val(this.subtotal),this.stripeCheckout()}},getTaxedAmount:function(){var e=Number.parseFloat(this.subtotal),t=Number.parseFloat(this.taxAmount);return Number.parseFloat(e+e*t).toFixed(2)},updateCostView:function(){a("span#localisedcost").text(this.getTaxedAmount()),a("span.subtotal-display").text(this.getTaxedAmount())},stripeCheckout:function(){var e=this;a.getScript("https://checkout.stripe.com/checkout.js",function(){StripeCheckout.configure({key:e.stripePublishableKey,image:e.stripeLogo||"https://stripe.com/img/documentation/checkout/marketplace.png",locale:"auto",billingAddressRequired:e.billingAddressRequired,shippingAddress:e.shippingAddressRequired,zipCode:e.validateZipCode,token:function(e){a("#stripe-form").append('<input type="hidden" name="stripeToken" value="'+e.id+'" />').append('<input type="hidden" name="stripeTokenType" value="'+e.type+'" />').append('<input type="hidden" name="stripeEmail" value="'+e.email+'" />').submit()}}).open({name:e.courseFullName,description:"Test description",zipCode:!0,amount:Math.floor(100*Number.parseFloat(e.getTaxedAmount()))})}).fail(function(){throw new Error("Could not load Stripe checkout library.")})},initClickHandlers:function(){var t=this;a("#apply-discount").click(function(){t.Discount.checkDiscountCode(t)}),a("#multiple-registration-btn").click(function(){t.MultipleRegistration.buildForm(a(this),t.mdlstr)}),a(".payment-checkout").click(function(e){e.preventDefault(),"paypal-button"===e.target.id?t.gateway="paypal":"stripe-button"===e.target.id&&(t.gateway="stripe"),t.MultipleRegistration.enabled?t.MultipleRegistration.verifyAndSubmit(t):a.ajax({url:r.wwwroot+"/enrol/payment/ajax/single_enrol.php",method:"POST",data:{prepaytoken:t.prepayToken},success:function(){t.checkoutFinal()},failure:function(){alert(t.mdlstr.errcommunicating)}})})},init:function(t,i,n,a,o,r,s,l,u,c){var p=this;d.get_strings([{key:"discounttypeerror",component:"enrol_payment"},{key:"discountamounterror",component:"enrol_payment"},{key:"invalidgateway",component:"enrol_payment"},{key:"errcommunicating",component:"enrol_payment"},{key:"addaregistrant",component:"enrol_payment"},{key:"removearegistrant",component:"enrol_payment"}]).done(function(e){p.mdlstr=e,p.originalCost=Number.parseFloat(n),p.taxAmount=Number.parseFloat(l),p.subtotal=Number.parseFloat(n).toFixed(2),p.instanceid=t,p.stripePublishableKey=i,p.courseFullName=o,p.shippingRequired=r,p.prepayToken=a,p.stripeLogo=s,p.validateZipCode=u,p.billingAddressRequired=c,p.initClickHandlers(),p.updateCostView()})}}});